<script>
    // Update time display
    function updateTime() {
        const now = new Date();
        const formattedTime = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true });
        document.getElementById('localTime').innerText = formattedTime;
    }

    // Update date display
    function updateDate() {
        const now = new Date();
        const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        const month = months[now.getMonth()];
        const day = String(now.getDate()).padStart(2, '0');
        const year = now.getFullYear();
        document.getElementById('localDate').innerText = `${month} ${day} ${year}`;
    }

    // Info rotator
    const infoItems = ['localTime', 'localDate', 'localWeather'];
    let currentIndex = 0;

    function rotateInfo() {
        const currentEl = document.getElementById(infoItems[currentIndex]);
        const nextIndex = (currentIndex + 1) % infoItems.length;
        const nextEl = document.getElementById(infoItems[nextIndex]);

        // Exit current
        currentEl.classList.remove('active');
        currentEl.classList.add('exit');

        // Enter next
        nextEl.classList.remove('exit');
        nextEl.classList.add('active');

        // Clean up exit class after transition
        setTimeout(() => {
            currentEl.classList.remove('exit');
        }, 400);

        currentIndex = nextIndex;
    }

    // Initialize
    updateTime();
    updateDate();
    document.getElementById('localTime').classList.add('active');

    // Update time every second
    setInterval(updateTime, 1000);

    // Rotate every 5 seconds
    setInterval(rotateInfo, 5000);

    // Event filtering
    const filterButtons = document.querySelectorAll('#filters .button');
    const events = document.querySelectorAll('.event');
    const weekSections = document.querySelectorAll('.week-section');

    function filterEvents() {
        const activeButton = document.querySelector('#filters .button:not(.inactive)');
        const activeTag = activeButton ? activeButton.textContent.toLowerCase() : null;

        events.forEach(event => {
            const tags = event.dataset.tags ? event.dataset.tags.split(',') : [];
            const show = !activeTag || tags.includes(activeTag);

            // Hide/show event (and parent <a> if exists)
            const wrapper = event.parentElement.tagName === 'A' ? event.parentElement : event;
            wrapper.style.display = show ? '' : 'none';
        });

        // Hide week sections with no visible events
        weekSections.forEach(section => {
            const visibleEvents = section.querySelectorAll('.event');
            const hasVisible = Array.from(visibleEvents).some(e => {
                const wrapper = e.parentElement.tagName === 'A' ? e.parentElement : e;
                return wrapper.style.display !== 'none';
            });
            section.style.display = hasVisible ? '' : 'none';
        });
    }

    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            const wasActive = !button.classList.contains('inactive');

            // Reset all buttons to inactive
            filterButtons.forEach(b => b.classList.add('inactive'));

            // If clicking an inactive button, activate it
            if (!wasActive) {
                button.classList.remove('inactive');
            }

            filterEvents();
        });
    });

    // Night mode - automatically activates after sunset, persists via localStorage
    window.isNightMode = () => document.documentElement.classList.contains('night-mode');

    (async function initNightMode() {
        let sunrise = null;
        let sunset = null;

        async function fetchSunTimes(lat, lng) {
            try {
                const response = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&formatted=0`);
                const data = await response.json();
                if (data.status === 'OK') {
                    sunrise = new Date(data.results.sunrise);
                    sunset = new Date(data.results.sunset);
                }
            } catch (e) {
                // Fallback: use approximate times (6 AM / 6 PM)
                const today = new Date();
                sunrise = new Date(today.setHours(6, 0, 0, 0));
                sunset = new Date(today.setHours(18, 0, 0, 0));
            }
        }

        function setNightMode(isNight) {
            document.documentElement.classList.toggle('night-mode', isNight);
            localStorage.setItem('nightMode', isNight);
            // Swap logo
            const logo = document.getElementById('site-logo');
            if (logo) {
                logo.src = isNight ? '/static/img/flyerLogo_night.svg' : '/static/img/flyerLogo.svg';
            }
        }

        function checkNightMode() {
            if (!sunrise || !sunset) return;
            const now = new Date();
            const isNight = now < sunrise || now > sunset;
            setNightMode(isNight);
        }

        // Get location and fetch sun times in background
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    await fetchSunTimes(position.coords.latitude, position.coords.longitude);
                    checkNightMode();
                },
                async () => {
                    await fetchSunTimes(37.8044, -122.2712); // Oakland fallback
                    checkNightMode();
                }
            );
        } else {
            await fetchSunTimes(37.8044, -122.2712);
            checkNightMode();
        }

        // Re-check every minute
        setInterval(checkNightMode, 1000);
    })();
</script>
